<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Baltic Exchange Scraper Dashboard</title>
    
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css" rel="stylesheet">
    
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .data-card {
            transition: transform 0.2s;
        }
        .data-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #206bc4;
        }
        .metric-label {
            color: #626976;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- Header -->
        <header class="navbar navbar-expand-md navbar-light d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <span class="text-primary">ðŸŒŠ</span>
                    Baltic Exchange Scraper
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm">
                                <span class="ti ti-ship"></span>
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="page-wrapper">
            <div class="container-xl">
                <!-- Page header -->
                <div class="page-header d-print-none">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="page-title">Market Data Dashboard</h2>
                            <div class="text-muted mt-1">Baltic Exchange weekly market data - view local data or update from source</div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="updateData()">
                                    <span class="ti ti-refresh me-2"></span>
                                    Update Data
                                </button>
                                <button class="btn btn-success" onclick="exportCSV()">
                                    <span class="ti ti-download me-2"></span>
                                    Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="row row-deck row-cards mb-4">
                    <div class="col-sm-6 col-lg-4">
                        <div class="card data-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Last Update</div>
                                </div>
                                <div class="metric-value" id="last-update">-</div>
                                <div class="metric-label">Latest data timestamp</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="card data-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Weekly Reports</div>
                                </div>
                                <div class="metric-value" id="total-reports">-</div>
                                <div class="metric-label">Total reports from 2025</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="card data-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Status</div>
                                </div>
                                <div class="metric-value" id="status">-</div>
                                <div class="metric-label">Connection status</div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Latest Data Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Latest Market Data</h3>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                                <span class="ti ti-refresh me-1"></span>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table">
                                <thead>
                                    <tr>
                                        <th>Week</th>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Capesize Content</th>
                                        <th>Panamax Content</th>
                                        <th>Ultramax/Supramax Content</th>
                                        <th>Handysize Content</th>
                                        <th>Report Link</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            Loading data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">Connection Status</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="connection-status-indicator"></span>
                                    <span id="connection-status-text">Checking connection...</span>
                                </div>
                                <div class="text-muted" id="connection-details">-</div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary" onclick="testConnection()">
                                    <span class="ti ti-wifi me-2"></span>
                                    Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    
    <script>
        // Global variables
        let dashboardData = null;
        let connectionStatus = 'unknown';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            // Removed automatic testConnection call to avoid web hits on load
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                const result = await response.json();
                
                if (result.status === 'success') {
                    dashboardData = result;
                    updateDashboard(result);
                } else {
                    console.error('Failed to load dashboard data:', result);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        // Update dashboard display
        function updateDashboard(data) {
            const summary = data.summary;
            
            // Update KPI cards
            document.getElementById('last-update').textContent = formatDate(summary.latest_update) || 'Never';
            document.getElementById('total-reports').textContent = summary.total_weekly_reports || 0;
            document.getElementById('status').textContent = connectionStatus === 'success' ? 'Connected' : 'Disconnected';
            
            // Update data table
            updateDataTable(data.data);
        }

        // Update data table
        function updateDataTable(data) {
            const tbody = document.getElementById('data-table-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            // Collect all weekly reports from all entries
            let allWeeklyReports = [];
            data.forEach(entry => {
                if (entry.weekly_reports && Array.isArray(entry.weekly_reports)) {
                    allWeeklyReports = allWeeklyReports.concat(entry.weekly_reports);
                }
            });
            
            if (allWeeklyReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No weekly reports available</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            allWeeklyReports.sort((a, b) => new Date(b.date_report) - new Date(a.date_report));
            
            tbody.innerHTML = allWeeklyReports.slice(0, 10).map(report => {
                return `
                    <tr>
                        <td>Week ${report.week_number || 'N/A'}</td>
                        <td>${report.date_report || 'N/A'}</td>
                        <td><span class="btn btn-sm btn-outline-primary">${report.category || 'N/A'}</span></td>
                        <td>${report.capesize_content ? report.capesize_content.substring(0, 100) + '...' : 'No content'}</td>
                        <td>${report.panamax_content ? report.panamax_content.substring(0, 100) + '...' : 'No content'}</td>
                        <td>${report.ultramax_supramax_content ? report.ultramax_supramax_content.substring(0, 100) + '...' : 'No content'}</td>
                        <td>${report.handysize_content ? report.handysize_content.substring(0, 100) + '...' : 'No content'}</td>
                        <td><a href="${report.link_report}" target="_blank" class="btn btn-sm btn-outline-primary">View Report</a></td>
                    </tr>
                `;
            }).join('');
        }



        // Update data
        async function updateData() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="ti ti-loader me-2"></span>Updating...';
            
            try {
                const response = await fetch('/api/update-data', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('Data updated successfully');
                    loadDashboardData();
                } else {
                    showError('Failed to update data: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating data:', error);
                showError('Failed to update data');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Export CSV
        async function exportCSV() {
            try {
                const response = await fetch('/api/export-csv');
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Create and download CSV file
                    const blob = new Blob([result.csv_data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `baltic_exchange_data_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('CSV exported successfully');
                } else {
                    showError('Failed to export CSV: ' + result.message);
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showError('Failed to export CSV');
            }
        }

        // Test connection
        async function testConnection() {
            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const testResult = result.connection_test;
                    connectionStatus = testResult.status;
                    
                    // Update status indicator
                    const indicator = document.getElementById('connection-status-indicator');
                    const text = document.getElementById('connection-status-text');
                    const details = document.getElementById('connection-details');
                    
                    indicator.className = `status-indicator status-${connectionStatus === 'success' ? 'success' : 'error'}`;
                    text.textContent = connectionStatus === 'success' ? 'Connected' : 'Connection Failed';
                    details.textContent = testResult.message || 'No details available';
                    
                    // Update main status
                    document.getElementById('status').textContent = connectionStatus === 'success' ? 'Connected' : 'Disconnected';
                } else {
                    connectionStatus = 'error';
                    showError('Connection test failed');
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                connectionStatus = 'error';
                showError('Connection test failed');
            }
        }

        // Refresh data
        function refreshData() {
            loadDashboardData();
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                
                // Format as dd/mm/yyyy hh:mm
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        }



        function showSuccess(message) {
            // You can implement a toast notification here
            console.log('Success:', message);
        }

        function showError(message) {
            // You can implement a toast notification here
            console.error('Error:', message);
        }
    </script>
</body>
</html>
